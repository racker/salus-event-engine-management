stream
  |from()
    .measurement('{{measurement}}')
    .groupBy('{{groupBy}}')
{{#windowLength}}
  |window()
    .period({{windowLength}}m)
    .every({{windowLength}}m)
{{/windowLength}}
{{#windowFields}}
  |max('{{.}}')
    .as('max_{{.}}')
  |min('{{.}}')
    .as('min_{{.}}')
  |mean('{{.}}')
    .as('avg_{{.}}')
{{/windowFields}}
{{#labelsAvailable}}
  |where(lambda:
  {{#labels}}
    isPresent("{{key}}") AND ("{{key}}" == '{{value}}')
    {{^-last}}
      AND
    {{/-last}}
    {{#-last}}
      )
    {{/-last}}
  {{/labels}}
{{/labelsAvailable}}
{{#joinedEvals}}
  |eval({{joinedEvals}})
    .as({{joinedAs}})
    .keep()
{{/joinedEvals}}
{{#critCount}}
  {{#critExpression}}
  |stateDuration(lambda: {{critExpression}})
    .unit(1m)
    .as('crit_count')
  {{/critExpression}}
{{/critCount}}
{{#warnCount}}
  {{#warnExpression}}
  |stateDuration(lambda: {{warnExpression}})
    .unit(1m)
    .as('warn_count')
  {{/warnExpression}}
{{/warnCount}}
{{#infoCount}}
  {{#infoExpression}}
  |stateDuration(lambda: {{infoExpression}})
    .unit(1m)
    .as('info_count')
  {{/infoExpression}}
{{/infoCount}}
  |alert()
    .stateChangesOnly()
    .id('{{alertId}}')
    .details('{{details}}')
{{#infoCount}}
    .info(lambda: {{infoCount}})
{{/infoCount}}
{{^infoCount}}
  {{#infoExpression}}
    .info(lambda: {{infoExpression}})
  {{/infoExpression}}
{{/infoCount}}
{{#warnCount}}
    .warn(lambda: {{warnCount}})
{{/warnCount}}
{{^warnCount}}
  {{#warnExpression}}
    .warn(lambda: {{warnExpression}})
  {{/warnExpression}}
{{/warnCount}}
{{#critCount}}
    .crit(lambda: {{critCount}})
{{/critCount}}
{{^critCount}}
  {{#critExpression}}
    .crit(lambda: {{critExpression}})
  {{/critExpression}}
{{/critCount}}
{{#flapping}}
    .flapping({{flappingLower}}, {{flappingUpper}})
{{/flapping}}
    .history({{history}})
    .topic('{{eventHandlerTopic}}')